import geopandas as gpdimport matplotlib.pyplot as pltimport matplotlib.cm as cmimport xarray as xrimport osimport seaborn as snsimport salemfrom matplotlib.ticker import FuncFormatterfrom shapely.geometry import Pointimport pandas as pdimport numpy as npfrom matplotlib import animationimport cartopy.crs as ccrsimport cartopy.feature as cfeaturefrom IPython.display import HTML, displayfrom matplotlib.colors import ListedColormapfrom matplotlib.colors import LinearSegmentedColormapfrom cartopy.mpl.gridliner import LONGITUDE_FORMATTER, LATITUDE_FORMATTERimport globimport xesmf as xe"""NOTE: File preferrably run in xemsf environment"""# %% Cell 1: (Default) regrid climate data  from raw input data, using  bilinear and nearest neighbour (perturbations only for now)def regrid_climate_data(plotvar, model, member, var, timeframe, mode, diftype, y0, ye):    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """    # Part 0: Provide regridding parameter    if var == "Precipitation":        var_suffix = "PR"        var_idx = "pr"    else:        var_suffix = "TEMP"        var_idx = "tas"    mode_suff = 'total'  # other option is std, but we're not interested in that for now    # Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid = xr.open_dataset(w5e5_path)    # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values,  # 'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values  # 'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })    # Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}"    if plotvar == "DIF":        # ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        # ifile_diff = f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    ds_in = xr.open_dataset(ifile_diff, engine="netcdf4")  # open the dataset    # find out what the variables are in each dataset    # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear',                             periodic=True, extrap_method='nearest_s2d')    # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))    # Perform the regridding    regridded_data = {}    regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)    "Regridded attributes:"    if var == "Precipitation":        regridded_ds.pr.attrs.update(ds_in.pr.attrs)    else:        regridded_ds.tas.attrs.update(ds_in.tas.attrs)    # print(regridded_ds.data_vars)    # Save the regridded data    base_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"    # create a new directory if it doesnt exist yet    if plotvar == "DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        # data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        # data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    # print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return# %% Counterfactual regriddingdef regrid_climate_data_counterfactual(plotvar, model, member, var, timeframe, mode, diftype):    y0 = 1985    ye = 2014    y0_cf = 1901    ye_cf = 1930    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """    # Part 0: Provide regridding parameter    if var == "Precipitation":        var_suffix = "PR"        var_idx = "pr"    else:        var_suffix = "TEMP"        var_idx = "tas"    mode_suff = 'total'  # other option is std, but we're not interested in that for now    # Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid = xr.open_dataset(w5e5_path)    # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values,  # 'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values  # 'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })    # Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}"    if plotvar == "DIF":        # ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    else:        # ifile_diff = f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    ds_in = xr.open_dataset(ifile_diff)  # open the dataset    # find out what the variables are in each dataset    # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear',                             periodic=True, extrap_method='nearest_s2d')    # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))    # Perform the regridding    regridded_data = {}    regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)    "Regridded attributes:"    if var == "Precipitation":        regridded_ds.pr.attrs.update(ds_in.pr.attrs)    else:        regridded_ds.tas.attrs.update(ds_in.tas.attrs)    # print(regridded_ds.data_vars)    # Save the regridded data    base_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"    # create a new directory if it doesnt exist yet    if plotvar == "DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        # data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"        # data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    # print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return# %% Cell 2: Run through regridder for all climate datay0 = 1985ye = 2014members = [4]  # 1, 3, 4, 6,3]# "IPSL-CM6", "E3SM", "CESM2", "CNRM", "NorESM"]):# IPSL-CM6", "E3SM", "CESM2", "CNRM", "NorESM"]):for (m, model) in enumerate(["NorESM"]):    for member in range(members[m]):        for plotvar in ["DIF"]:  # alternatively also for IRR, NOI, not of interest at the moment            for var in ["Precipitation", "Temperature"]:  # , "Precipitation"]:                for timeframe in ["annual", "seasonal", "monthly"]:                    # alternatively also for std, not of interest at the moment                    for mode in ['dif']:                        if plotvar == "DIF" and var == "Precipitation" and mode == 'dif':                            diftypes = ['abs', 'rel']                        else:                            diftypes = ['abs']                        for dif in diftypes:                            print(plotvar, model, member, var, dif)                            # if model=="NorESM":                            regrid_climate_data(                                plotvar, model, member, var, timeframe, mode, dif, 1985, 2014)                            # regrid_climate_data_counterfactual(                            #     plotvar, model, member, var, timeframe, mode, dif)# %% Cell 3: Plot the climate data from faw data (illustrative grid plot)"""Please note that all functions below here might be outddated --> used for showing the grid location from before to after regridding"""# cmap=cm.get_cmap('bone')# colors=[cmap(i / 5) for i in range(6)]fig, ax = plt.subplots(figsize=(20, 10), subplot_kw={                       'projection': ccrs.PlateCarree()})colors = ['red', 'cyan', 'blue', 'purple', 'black']models = ["W5E5", "IPSL-CM6", "E3SM", "CESM2", "CNRM"]mode_suff = 'total'# %% Cell 4: Create a plot of the initial grid per climate modeldef plot_data_initial_grid():    for (i, model) in enumerate(models):        color_code = colors[i]        """ Load the data """        if model == "W5E5":            w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'            # print(w5e5_path)            grid = xr.open_dataset(w5e5_path)            linestyle = "dashed"        else:            folder = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/"            ifile_IRR = f"{model}.IRR.000.{y0}_{ye}_selparam_monthly_{mode_suff}.nc"            linestyle = "dashed"            # first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]            grid = xr.open_dataset(folder+ifile_IRR)        # cut out the  relevants seciton to later plot on the grid        grid = grid.where((grid.lon >= 88) & (grid.lon <= 97) & (            grid.lat >= 28) & (grid.lat <= 37), drop=True)        # define the lon and latitude poitns in the dataset        lon = grid.lon        lat = grid.lat        print(model, lon[1:5].values, lat[1:5].values)        # create a meshgrid out of the lon and latitude points        lon_grid, lat_grid = np.meshgrid(lon, lat)        # print(lon_grid, lat_grid)        # Plot the grid lines, using a scatter graph for the corners and connect htem in a loop        for j in range(len(lon)):            for k in range(len(lat)):                if j < len(lon) - 1 and k < len(lat) - 1:                    ax.plot([lon[j], lon[j+1]], [lat[k], lat[k]], linestyle=linestyle,                            color=color_code, alpha=0.6, dashes=[5, 5])                    ax.plot([lon[j], lon[j]], [lat[k], lat[k+1]], linestyle=linestyle,                            color=color_code, alpha=0.6, dashes=[5, 5])                    # ax.fill_between([lon[j], lon[j+1]], lat[k], lat[k+1], color=color_code, alpha=0.3)  # Fill squares        ax.scatter(lon_grid, lat_grid, color=color_code,                   marker='s', label=model, s=50)    # modify the figure    ax.set_xlim((90, 95))  # Adjust as needed    ax.set_ylim((30, 35))  # Adjust as needed    ax.set_xticks(np.arange(90, 96, 1))  # Adjust as needed    ax.set_yticks(np.arange(30, 36, 1))  # Adjust as needed    ax.set_ylabel('Latitude °')    ax.set_xlabel('Longitude °')    ax.legend()    ax.set_title('Data Product Grid by Climate model')    plt.tight_layout()    # plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9)    plt.show()    # Add geographic features    # ax.add_feature(cfeature.COASTLINE)    # ax.add_feature(cfeature.BORDERS)    # ax.add_feature(cfeature.LAND, edgecolor='black')    return# %% Cell 5: Plotting the climate data - only for perturbationsdef reverse_latitudes(ds):    latitudes = ds.lat.values    if latitudes[0] > latitudes[-1]:  # Latitudes are in descending order        # Reverse the latitude coordinates and data        ds = ds.reindex(lat=ds.lat[::-1])    return dsdef adjust_longitudes(ds, lon_name='lon'):    """    Adjust longitudes in an xarray dataset from the -180 to 180 system to the 0 to 360 system,    and realign the data accordingly.    Parameters:    ds (xarray.Dataset): The input dataset containing longitude coordinates.    lon_name (str): The name of the longitude coordinate in the dataset (default is 'lon').    Returns:    xarray.Dataset: A new dataset with adjusted longitudes and data realigned.    """    # Extract the longitude values    longitudes = ds[lon_name].values    # Adjust longitudes: Add 360 to negative longitudes    adjusted_longitudes = np.where(        longitudes > 180, longitudes - 360, longitudes)    # Assign the adjusted longitudes back to the dataset    ds = ds.assign_coords({lon_name: adjusted_longitudes})    # Sort the dataset by the new longitudes    ds = ds.sortby(lon_name)    return dsdef plot_P_T_perturbations(models, members, scale, var, timeframe, mode, diftype, plotsave):    irrmip_folder = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/IRRMIP/all_members/"    model_folder = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/IRRMIP/gcm_avg/"    os.makedirs(irrmip_folder, exist_ok=True)    os.makedirs(model_folder, exist_ok=True)    if var == "Precipitation":        var_suffix = "PR"        if mode == 'dif' and diftype == 'rel':            mode_suff = 'total'            vmin = -40            vmax = 40            zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))            colors = [(0, 'xkcd:mocha'), (zero_scaled,                                          'xkcd:white'), (1, 'xkcd:aquamarine')]            custom_cmap = LinearSegmentedColormap.from_list(                'custom_cmap', colors)        if mode == 'dif' and diftype == 'abs':            mode_suff = 'total'            vmin = -50            vmax = 75            zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))            colors = [(0, 'xkcd:mocha'), (zero_scaled,                                          'xkcd:white'), (1, 'xkcd:aquamarine')]            custom_cmap = LinearSegmentedColormap.from_list(                'custom_cmap', colors)        if mode == 'std':            mode_suff = 'std'            vmin = -40            vmax = 40            zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))            colors = [(0, 'xkcd:peach'), (zero_scaled, 'xkcd:white'),                      (1, 'xkcd:light aquamarine')]            custom_cmap = LinearSegmentedColormap.from_list(                'custom_cmap', colors)    elif var == "Temperature":        var_suffix = "TEMP"        if mode == 'dif':            mode_suff = 'total'            vmin = -1.5            vmax = 1.5            zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))            colors = [(0, 'cornflowerblue'), (zero_scaled,                                              'xkcd:white'), (1, 'xkcd:tomato')]            custom_cmap = LinearSegmentedColormap.from_list(                'custom_cmap', colors)        if mode == 'std':            mode_suff = 'std'            vmin = -1.5            vmax = 1.5            zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))            colors = [(0, 'xkcd:lightblue'), (zero_scaled,                                              'xkcd:white'), (1, 'xkcd:pink')]            custom_cmap = LinearSegmentedColormap.from_list(                'custom_cmap', colors)    for m, model in enumerate(models):        for member in range(members[m]):            """ Part 1: Load the input data (derived in function process_P_T_perturbations) """            diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"            ifile_diff = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"            ofile_diff_bymember = f"{irrmip_folder}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"            ofile_diff_modelavg = f"{model_folder}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"            diff = xr.open_dataset(ifile_diff)            # save the data for IRRMIP total            diff = reverse_latitudes(diff)            diff = adjust_longitudes(diff)            # only save local if requested            if scale == "Local":                diff = diff.where((diff.lon >= 60) & (diff.lon <= 109) & (                    diff.lat >= 22) & (diff.lat <= 52), drop=True)            # print(diff.lon[1].values,diff.lon[-1].values)            # print(diff.lat[1].values,diff.lat[-1].values)            if member == 0:                diff.to_netcdf(ofile_diff_modelavg)            else:                diff.to_netcdf(ofile_diff_bymember)            # print(diff_sel.time)    # Load all IRRMIP data    # print(glob.glob(f"{irrmip_folder}/*.nc"))    # , compat="override") #overriding bcs attributes/metadata are different    ds_all = xr.open_mfdataset(        f"{irrmip_folder}/*.nc", combine="nested", concat_dim="member")    # Compute the average precipitation across all members    diff = ds_all.mean(dim="member", skipna=True)    """ Part 0 - Set plotting parameters"""    # adjust figure sizes towards type of plot    if scale == "Global":        if timeframe == 'monthly':            figsize = (25, 12)            fig, axes = plt.subplots(nrows=3, ncols=4, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'ymon'            timestamps = ['JAN', 'FEB', 'MAR', 'APR', 'MAY',                          'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']            time_averaging = 'time.month'            time_type = 'month'            col_wrap = 4        if timeframe == 'seasonal':            figsize = (12, 7.5)            fig, axes = plt.subplots(nrows=2, ncols=2, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'yseas'            timestamps = ['DJF', 'MAM', 'JJA', 'SON']            time_averaging = 'time.season'            time_type = 'season'            col_wrap = 2        if timeframe == 'annual':            figsize = (7, 5)            fig, axes = plt.subplots(nrows=1, ncols=1, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'year'            timestamps = ['YEAR']            time_averaging = 'time.year'            time_type = 'year'            col_wrap = 1    if scale == "Local":        if timeframe == 'monthly':            figsize = (18, 10)            fig, axes = plt.subplots(nrows=3, ncols=4, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'ymon'            timestamps = ['JAN', 'FEB', 'MAR', 'APR', 'MAY',                          'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']            time_averaging = 'time.month'            time_type = 'month'            col_wrap = 4        if timeframe == 'seasonal':            figsize = (9, 7)            fig, axes = plt.subplots(nrows=2, ncols=2, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'yseas'            timestamps = ['DJF', 'MAM', 'JJA', 'SON']            time_averaging = 'time.season'            time_type = 'season'            col_wrap = 2        if timeframe == 'annual':            figsize = (7, 5)            fig, axes = plt.subplots(nrows=1, ncols=1, subplot_kw={                'projection': ccrs.PlateCarree()}, figsize=figsize)            time_signature = 'year'            timestamps = ['YEAR']            time_averaging = 'time.year'            time_type = 'year'            col_wrap = 1    # Provide cbar ranges and colors for plots for different variables, modes (dif/std) and difference types (abs/rel)    # create local minima/maxima, for axis of plot    local_min_diff = diff.quantile(0.25)    local_max_diff = diff.quantile(0.75)    """ Part 2 - Shapefile outline for Karakoram Area to be included"""    # path to  shapefile    shapefile_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/03. Shapefile/Karakoram/Pan-Tibetan Highlands/Pan-Tibetan Highlands (Liu et al._2022)/Shapefile/Pan-Tibetan Highlands (Liu et al._2022)_P.shp'    shp = gpd.read_file(shapefile_path)    target_crs = 'EPSG:4326'    shp = shp.to_crs(target_crs)    """ Part 3 - Create subplots for IRR, NOI and DIF"""    # first create output folders for the data    o_folder_base = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/04. Figures/01. Climate data/01. Input data/{scale}/{var}/{model}/{member}"    o_folder_diff = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/04. Figures/01. Climate data/02. Perturbations/{scale}/{var}/{model}/{member}"    for time_idx, timestamp_name in enumerate(timestamps):        # indicate the column and row of the subplot to plot in        if timeframe == 'monthly':            row = (time_idx) // 4  # Calculate row index            col = (time_idx) % 4            ax = axes[row, col]        if timeframe == 'seasonal':            row = (time_idx) // 2            col = (time_idx) % 2            ax = axes[row, col]        if timeframe == 'annual':            row = 0            col = 0            ax = axes        """ 3A Plotting data, incl karakoram outline """        # select relevant month/season and only 1 year for annual to plot and annotate        if scale == "Local":            time_dim_name = list(diff.dims)[0]        if scale == "Global":            if timeframe != 'annual':                time_dim_name = list(diff.dims)[2]        if timeframe == 'annual':            diff_sel = diff        else:            diff_sel = diff.isel({time_dim_name: time_idx})        # make into dataframe, else it doesnt work        if isinstance(diff_sel, xr.Dataset):            diff_sel = diff_sel[list(diff_sel.data_vars.keys())[0]]        # plot the data incl the outline of the karakoram shapefile, setting the colors, but excluding the shapefile        im = diff_sel.plot.imshow(ax=ax, vmin=vmin, vmax=vmax, extend='both',                                  transform=ccrs.PlateCarree(), cmap=custom_cmap, add_colorbar=False)        shp.plot(ax=ax, edgecolor='black',                 linewidth=1, facecolor='none')        # shp.plot(ax=ax, edgecolor='red', linewidth=1, facecolor='none')        ax.coastlines(resolution='10m')        # include month as a label, instead as on top off data        ax.set_title('')        ax.annotate(timestamp_name, xy=(1, 1), xytext=(-10, -10), xycoords='axes fraction', textcoords='offset points',                    ha='right', va='top', fontsize=15, bbox=dict(boxstyle='square', fc='white', alpha=1))        """ 3B - Min and Max value annotation"""        # Include annotation for min and max values in every subplot, excluding NaN from min/max creation        diff_sel_min = diff_sel.fillna(diff_sel.max())        diff_sel_max = diff_sel.fillna(diff_sel.min())        # find min and max values in gridcell        min_value_index = np.unravel_index(            np.argmin(diff_sel_min.values), diff_sel_min.shape)        max_value_index = np.unravel_index(            np.argmax(diff_sel_max.values), diff_sel_max.shape)        # Extract longitude and latitude corresponding to the minimum and maximum value indices        min_lon, min_lat = diff_sel.lon.values[min_value_index[1]                                               ], diff_sel.lat.values[min_value_index[0]]        max_lon, max_lat = diff_sel.lon.values[max_value_index[1]                                               ], diff_sel.lat.values[max_value_index[0]]        # Plot the dot on the subplot        ax.plot(min_lon, min_lat, marker='o', markersize=7,                color='blue')  # Adjust marker properties as needed        ax.plot(max_lon, max_lat, marker='o', markersize=7,                color='red')  # Adjust marker properties as needed        # #indicate annotations for min and max values in plot, formatted as percenteges for rel precipitation differences        min_value = diff_sel[min_value_index]        max_value = diff_sel[max_value_index]        print(min_value)  # plotting coordinates instead of number        print(max_value)        if scale == "Local":            if timeframe == 'annual':                ax.annotate(f'Min: {min_value:.1f}', xy=(65, 50), xytext=(                    65, 50), fontsize=15, ha='left', va='top')                ax.annotate(f'Max: {max_value:.1f}', xy=(78, 50), xytext=(                    78, 50), fontsize=15, ha='left', va='top')                ax.plot(64, 49.4, marker='o',                        color='blue', markersize=5)                ax.plot(77, 49.4, marker='o',                        color='red', markersize=5)            else:                ax.annotate(f'Min: {min_value:.1f}', xy=(64, 50), xytext=(                    64, 50), fontsize=14, ha='left', va='top')                ax.annotate(f'Max: {max_value:.1f}', xy=(84, 50), xytext=(                    84, 50), fontsize=14, ha='left', va='top')                ax.plot(62, 49, marker='o', color='blue', markersize=5)                ax.plot(82, 49, marker='o', color='red', markersize=5)        if scale == "Global":            if timeframe == 'monthly':                ax.annotate(f'Min: {min_value:.1f}', xy=(                    0, -75), xytext=(0, -75), fontsize=15, ha='left', va='top')                ax.annotate(f'Max: {max_value:.1f}', xy=(                    85, -75), xytext=(85, -75), fontsize=15, ha='left', va='top')                ax.plot(-4, -78, marker='o',                        color='blue', markersize=5)                ax.plot(80, -78, marker='o', color='red', markersize=5)            else:                ax.annotate(f'Min: {min_value:.1f}', xy=(                    0, -75), xytext=(0, -75), fontsize=15, ha='left', va='top')                ax.annotate(f'Max: {max_value:.1f}', xy=(                    85, -75), xytext=(85, -75), fontsize=15, ha='left', va='top')                ax.plot(-4, -79, marker='o',                        color='blue', markersize=5)                ax.plot(80, -79, marker='o', color='red', markersize=5)        # Set the map gridlines        gl = ax.gridlines(draw_labels=True)        gl.top_labels = False        gl.right_labels = False        # Set x-ticks using latitude values        if col == 0:            gl.ylabel_style = {'size': 15}            gl.ylocator = plt.MaxNLocator(nbins=3)        else:            gl.left_labels = False        if (timeframe == 'monthly' and row == 2) or (timeframe == 'seasonal' and row == 1) or (timeframe == 'annual'):            gl.xlabel_style = {'size': 15}            gl.xlocator = plt.MaxNLocator(nbins=3)        else:            gl.bottom_labels = False        gl.xformatter = LONGITUDE_FORMATTER        gl.yformatter = LATITUDE_FORMATTER    """ 3C Add color bar for entire plot"""    # add cbar in the figure, for overall figure, not subplots    # Define the position of the colorbar    cbar_ax = fig.add_axes([0.92, 0.1, 0.02, 0.8])    cbar = fig.colorbar(im, cax=cbar_ax, extend='both')    # adjust subplot spacing to be smaller    plt.subplots_adjust(left=0.1, right=0.9, bottom=0.1,                        top=0.9, wspace=0.05, hspace=0.05)    # Set label and tick parameters for the colorbar    if var == "Precipitation":        if mode == 'std' or diftype == 'abs':            unit = 'mm'        else:            unit = '%'    elif var == "Temperature":        unit = '°C'    else:        unit = 'Unknown'    """4 Include labels for the cbar and for the y and x axis"""    # Increase distance between colorbar label and colorbar    cbar.ax.yaxis.labelpad = 20    if mode == 'dif':        cbar.set_label(f'$\Delta$ {var} [{unit}]', size='15')        if mode == 'std':            cbar.set_label(                f'{var} - model member std [{unit}]', size='15')    cbar.ax.tick_params(labelsize=15)    if timeframe == 'monthly':        fig.text(0.5, 0.03, 'Longitude', ha='center', fontsize=15)        fig.text(0.03, 0.5, 'Latitude', va='center',                 rotation='vertical', fontsize=15)        fig.text(0.5, 0.92, model, ha='center', fontsize=20)    else:        fig.text(0.5, 0.01, 'Longitude', ha='center', fontsize=15)        fig.text(-0.02, 0.5, 'Latitude', va='center',                 rotation='vertical', fontsize=15)        fig.text(0.5, 0.92, model, ha='center', fontsize=20)    if plotsave == 'save':        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{o_folder_diff}/", exist_ok=True)        o_file_name = f"{o_folder_diff}/{model}.{var_suffix}.DIF.00{member}.{y0}_{ye}_{timeframe}_{diftype}.png"        # plt.savefig(o_file_name, bbox_inches='tight')    # plt.show()    returnmembers = [1, 3, 4, 6]models = ["IPSL-CM6", "E3SM", "CESM2", "CNRM"]# for (m, model) in enumerate(["IPSL-CM6", "E3SM", "CESM2", "CNRM"]):#     for member in range(members[m]):#         print(member)for scale in ["Local"]:  # ,"Global"]:    for plotvar in ["DIF"]:  # "IRR", "NOI"]:#,"DIF"]:        # "Temperature", "Precipitation"]:        for var in ["Precipitation"]:            for timeframe in ["annual"]:  # , "seasonal", "monthly"]:                for mode in ['dif']:  # , 'std']:                    if plotvar == "DIF" and var == "Precipitation" and mode == 'dif':                        diftypes = ["rel"]  # abs','rel']                    else:                        diftypes = ["abs"]                    for dif in diftypes:                        print(dif)                        plot_P_T_perturbations(                            models, members, scale, var, timeframe, mode, dif, "nosave")