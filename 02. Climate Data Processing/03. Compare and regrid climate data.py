import geopandas as gpdimport matplotlib.pyplot as pltimport matplotlib.cm as cmimport xarray as xrimport osimport seaborn as snsimport salemfrom matplotlib.ticker import FuncFormatterfrom shapely.geometry import Point import pandas as pdimport numpy as npfrom matplotlib import animationimport cartopy.crs as ccrsimport cartopy.feature as cfeaturefrom IPython.display import HTML, displayfrom matplotlib.colors import ListedColormapfrom matplotlib.colors import LinearSegmentedColormapimport xesmf as xe"""NOTE: File preferrably run in xemsf environment"""#%% Cell 1: (Default) regrid climate data  from raw input data, using  bilinear and nearest neighbour (perturbations only for now)def regrid_climate_data(plotvar, model, member, var, timeframe, mode, diftype):    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """            #Part 0: Provide regridding parameter    if var=="Precipitation":        var_suffix="PR"        var_idx="pr"    else:        var_suffix="TEMP"        var_idx="tas"    mode_suff='total' #other option is std, but we're not interested in that for now        #Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid=xr.open_dataset(w5e5_path)        # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values, #'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values #'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })        #Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"      diff_folder_in=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}"      if plotvar=="DIF":         ifile_diff=f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.1985_2014_{timeframe}_{diftype}.nc"    else:        ifile_diff=f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.1985_2014_{timeframe}_{diftype}.nc"        ds_in = xr.open_dataset(ifile_diff) #open the dataset    print(ds_in.data_vars)    #find out what the variables are in each dataset                # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear', periodic=True, extrap_method='nearest_s2d')        # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))        # Perform the regridding    regridded_data={}        regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)        # print(regridded_ds.data_vars)        # Save the regridded data    base_folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"     diff_folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"     #create a new directory if it doesnt exist yet    if plotvar=="DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        data_out=f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.1985_2014_{timeframe}_{diftype}.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out=f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.1985_2014_{timeframe}_{diftype}.nc"    print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return#%% Cell 2: Run through regridder for all climate data members=[1,3,4,6]for (m,model) in enumerate(["IPSL-CM6","E3SM","CESM2", "CNRM"]):     for member in range(members[m]):            for plotvar in ["DIF"]: #alternatively also for IRR, NOI, not of interest at the moment                for var in ["Temperature", "Precipitation"]:                    for timeframe in ["annual","seasonal","monthly"]:                        for mode in ['dif']: #alternatively also for std, not of interest at the moment                            if plotvar=="DIF" and var =="Precipitation" and mode=='dif':                                diftypes=['abs','rel']                             else:                                diftypes=['abs']                                                        for dif in diftypes:                                print(plotvar, model, member, var, dif)                                                      regrid_climate_data(plotvar, model, member, var, timeframe, mode, dif)#%% Cell 3: Plot the climate data from faw data (illustrative grid plot)"""Please note that all functions below here might be outddated --> used for showing the grid location from before to after regridding"""# cmap=cm.get_cmap('bone')# colors=[cmap(i / 5) for i in range(6)]fig, ax = plt.subplots(figsize=(20, 10), subplot_kw={'projection': ccrs.PlateCarree()})colors=['red', 'cyan', 'blue', 'purple', 'black']models=["W5E5", "IPSL-CM6","E3SM","CESM2", "CNRM"] mode_suff='total'#%% Cell 4: Create a plot of the initial grid per climate modeldef plot_data_initial_grid():    for (i,model) in enumerate(models):         color_code=colors[i]                """ Load the data """            if model=="W5E5":            w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'            # print(w5e5_path)            grid=xr.open_dataset(w5e5_path)            linestyle="dashed"        else:            folder=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/"               ifile_IRR=f"{model}.IRR.000.1985_2014_selparam_monthly_{mode_suff}.nc"            linestyle="dashed"                        #first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]            grid =xr.open_dataset(folder+ifile_IRR)                        #cut out the  relevants seciton to later plot on the grid        grid = grid.where((grid.lon >= 88) & (grid.lon <= 97) & (grid.lat >= 28) & (grid.lat <= 37), drop=True)            #define the lon and latitude poitns in the dataset        lon = grid.lon        lat = grid.lat            print(model, lon[1:5].values, lat[1:5].values)            #create a meshgrid out of the lon and latitude points        lon_grid, lat_grid = np.meshgrid(lon, lat)        # print(lon_grid, lat_grid)                # Plot the grid lines, using a scatter graph for the corners and connect htem in a loop        for j in range(len(lon)):            for k in range(len(lat)):                if j < len(lon) - 1 and k < len(lat) - 1:                    ax.plot([lon[j], lon[j+1]], [lat[k], lat[k]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                    ax.plot([lon[j], lon[j]], [lat[k], lat[k+1]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                    # ax.fill_between([lon[j], lon[j+1]], lat[k], lat[k+1], color=color_code, alpha=0.3)  # Fill squares        ax.scatter(lon_grid, lat_grid, color=color_code, marker='s', label=model, s=50)            #modify the figure    ax.set_xlim((90,95))  # Adjust as needed    ax.set_ylim((30,35))  # Adjust as needed    ax.set_xticks(np.arange(90, 96, 1))  # Adjust as needed    ax.set_yticks(np.arange(30, 36, 1))  # Adjust as needed    ax.set_ylabel('Latitude 째')    ax.set_xlabel('Longitude 째')        ax.legend()    ax.set_title('Data Product Grid by Climate model')    plt.tight_layout()    # plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9)        plt.show()            # Add geographic features    # ax.add_feature(cfeature.COASTLINE)    # ax.add_feature(cfeature.BORDERS)    # ax.add_feature(cfeature.LAND, edgecolor='black')    return#%% Cell 5: (Outdated) regrid climate data from raw input data, using  bilinear and nearest neighbour - was used for cell 1 & 3 on grid plottingdef regrid_initial_climate_data_outdated():    #open w5e5 dataset as this is the target grid    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'    grid=xr.open_dataset(w5e5_path)        # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values, #'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values #'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })        mode_suff='total'    types=['IRR', 'NOI']        for (i,model) in enumerate(models):         if model=="E3SM" or model=="CESM2":            if model =="E3SM":                members=3 #2 members 1 average            else:                members=4            variables=['pr', 'tas', 'sn'] #snow data only available for IPSL-CM6 and E3SM        else:            if model=="IPSL-CM6":                members=1 #1 members = average            else:                members=6 #5 members, 1 average            variables=['pr', 'tas'] #snow data only available for IPSL-CM6 and E3SM                if model != "W5E5":             for typ in types:                for m in np.arange(0,members,1):                        folder_in=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/01. Climate data/{model}"                       data_in=f"{folder_in}/{model}.{typ}.00{m}.1985_2014_selparam_monthly_{mode_suff}.nc"                    ds_in = xr.open_dataset(data_in)                    # print(ds_in.data_vars)                    # ds_in['mask'] = xr.where(np.isfinite(var), 1, 0)                                # Create the regridder                    regridder = xe.Regridder(ds_in, ds_out, 'bilinear', periodic=True, extrap_method='nearest_s2d')                                        # Reformat the input and output shape bcs else a error will result from conversion                    # https://github.com/pangeo-data/xESMF/issues/315                    regridder.shape_in = tuple(map(int, regridder.shape_in))                    regridder.shape_out = tuple(map(int, regridder.shape_out))                                # Perform the regridding                    regridded_data={}                    for (v,var) in enumerate(variables):                        print(model, var)                        regridded_data[var] = regridder(ds_in[var])                    regridded_ds = xr.Dataset(regridded_data)                                print(regridded_ds.data_vars)                                # Save the regridded data                    folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/01. Regridded data"                       #create a new directory if it doesnt exist yet                    os.makedirs(folder_out, exist_ok=True)                    data_out=f"{folder_out}/REGRID.{model}.{typ}.00{m}.1985_2014_selparam_monthly_{mode_suff}.nc"                    print("saving file to:", data_out)                    regridded_ds.to_netcdf(data_out)    return#%% Cell 6: check and plot grid of regridded climate datadef plot_data_regridded_grid():    fig, ax = plt.subplots(figsize=(20, 10), subplot_kw={'projection': ccrs.PlateCarree()})        for (i,model) in enumerate(models):         color_code=colors[i]                """ Load the data """            if model=="W5E5":            w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'            # print(w5e5_path)            grid=xr.open_dataset(w5e5_path)            linestyle="dashed"        else:            folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/01. Regridded data"               data_out=f"{folder_out}/REGRID.{model}.IRR.000.1985_2014_monthly_{mode_suff}.nc"                linestyle="dashed"                        #first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]            grid =xr.open_dataset(data_out)                        #cut out the  relevants seciton to later plot on the grid        grid = grid.where((grid.lon >= 88) & (grid.lon <= 97) & (grid.lat >= 28) & (grid.lat <= 37), drop=True)            #define the lon and latitude poitns in the dataset        lon = grid.lon        lat = grid.lat            print(model, lon[1:5].values, lat[1:5].values)            #create a meshgrid out of the lon and latitude points        lon_grid, lat_grid = np.meshgrid(lon, lat)        # print(lon_grid, lat_grid)                # Plot the grid lines, using a scatter graph for the corners and connect htem in a loop        for j in range(len(lon)):            for k in range(len(lat)):                if j < len(lon) - 1 and k < len(lat) - 1:                    ax.plot([lon[j], lon[j+1]], [lat[k], lat[k]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                    ax.plot([lon[j], lon[j]], [lat[k], lat[k+1]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                    # ax.fill_between([lon[j], lon[j+1]], lat[k], lat[k+1], color=color_code, alpha=0.3)  # Fill squares        ax.scatter(lon_grid, lat_grid, color=color_code, marker='s', label=model, s=50)            #modify the figure    ax.set_xlim((90,95))  # Adjust as needed    ax.set_ylim((30,35))  # Adjust as needed    ax.set_xticks(np.arange(90, 96, 1))  # Adjust as needed    ax.set_yticks(np.arange(30, 36, 1))  # Adjust as needed    ax.set_ylabel('Latitude 째')    ax.set_xlabel('Longitude 째')        ax.legend()    ax.set_title('REGRIDDED - Data Product Grid by Climate model')    plt.tight_layout()    # plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9)        plt.show()                    # Add geographic features        # ax.add_feature(cfeature.COASTLINE)        # ax.add_feature(cfeature.BORDERS)        # ax.add_feature(cfeature.LAND, edgecolor='black')    return#%% 