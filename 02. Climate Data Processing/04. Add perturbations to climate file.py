import numpy as npimport pandas as pdimport matplotlib.pyplot as pltimport xarray as xrimport cartopy.crs as ccrs#%% Cell 1: Import climate dataimport osfrom matplotlib.colors import LinearSegmentedColormap#%% Cell 1: define function to reformat monthly perturbations into 30-yr timeseriesdef repeat_time_data(ds, variable_name, new_time_range, time_id):    """    Repeat the data to match the new time range.    Parameters:    - ds: xarray.Dataset containing the data    - variable_name: Name of the variable to repeat    - new_time_range: New time range to expand the data to    - time_id: Identifier for the time dimension ('year', 'season', 'month')    Returns:    - xarray.Dataset with expanded time dimension    """    # Extract the data and dimensions    data = ds[variable_name].values    dims = ds[variable_name].dims    coords = ds[variable_name].coords    if time_id in dims:        # Time dimension exists        time_dim_index = dims.index(time_id)        original_time_length = len(ds.coords[time_id])        num_reps = len(new_time_range) // original_time_length        expanded_data = np.tile(data, (num_reps, *([1] * (len(dims) - 1))))        expanded_dims = ['time'] + [dim for dim in dims if dim != time_id]        expanded_coords = {            'time': new_time_range,            **{dim: coords[dim] for dim in dims if dim != time_id}        }    else:        # Time dimension does not exist (e.g., annual data)        num_reps = len(new_time_range)        expanded_data = np.tile(data, (num_reps, *([1] * len(dims))))        expanded_dims = ['time'] + list(dims)        expanded_coords = {            'time': new_time_range,            **{dim: coords[dim] for dim in dims}        }    expanded_data_array = xr.DataArray(        expanded_data,        dims=expanded_dims,        coords=expanded_coords    )    # Create a new Dataset with the expanded time dimension    expanded_ds = xr.Dataset(        {variable_name: expanded_data_array}    )    return expanded_ds#%% Cell 2: Load the base data# fig, ax = plt.subplots(figsize=(20, 10), subplot_kw={'projection': ccrs.PlateCarree()})models=["IPSL-CM6","E3SM","CESM2", "CNRM"]members=[0,3,6,4]mode_suff='total'# w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly'# pr_path=f'{w5e5_path}/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'# tas_path=f'{w5e5_path}/gswp3-w5e5_obsclim_tas_global_monthly_1901_2019.nc'#%% Cell 3: Add the perturbations to the baseline to create 1 output fileplot="off"members = [1, 3, 4, 6, 1]#W5E5 is included in the models to make a baseline output filefor timeframe in ["annual", "seasonal", "monthly"]:            #load the baseline data derived from OGGM uni-bremen server - after processing    ifolder_baseline_pr=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/Precipitation/{timeframe}/W5E5/0"      ifolder_baseline_tas=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/Temperature/{timeframe}/W5E5/0"          for (m, model) in enumerate(["IPSL-CM6", "E3SM", "CESM2", "CNRM", "W5E5"]):        if model =="W5E5":            y0s = [1985,1901]        else:            y0s = [1985]        for y0 in y0s:                        ifile_baseline_pr=f"{ifolder_baseline_pr}/W5E5.PR.BASE.000.{y0}_2014_{timeframe}_abs.nc"            ifile_baseline_tas=f"{ifolder_baseline_tas}/W5E5.TEMP.BASE.000.{y0}_2014_{timeframe}_abs.nc"            # The baseline contains two seperate files for tas en pr and rename coordinates to match            pr_baseline_timeseries_tot = xr.open_dataset(ifile_baseline_pr)            tas_baseline_timeseries_avg = xr.open_dataset(ifile_baseline_tas)                        for member in range(members[m]):                for plotvar in ["DIF"]: # alternatively also for irr, noi, not of interest at the moment                        for mode in ['DIF']: # alternatively also for std, not of interest at the moment                            print(model, member, timeframe)                                                        if timeframe == 'monthly':                                freq = 'MS'                                time_id = 'month'                                time_averaging = 'time.month'                            if timeframe == 'seasonal':                                freq = 'QS-DEC'                                time_id = 'season'                                time_averaging = 'time.season'                            if timeframe == 'annual':                                freq = 'YE'                                time_id = 'year'                                time_averaging = 'time.year'                                                                                             if model!="W5E5":                                date_range = pd.date_range(start='1985-01-01', end='2014-12-31', freq=freq)                                diff_folder_pr = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/Precipitation/{timeframe}/{model}/{member}"                                diff_folder_tas = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/Temperature/{timeframe}/{model}/{member}"                                            # create a new directory if it doesn't exist yet                                pr_perturbation_path = f"{diff_folder_pr}/REGRID.{model}.PR.{plotvar}.00{member}.{y0}_2014_{timeframe}_rel.nc"                                tas_perturbation_path = f"{diff_folder_tas}/REGRID.{model}.TEMP.{plotvar}.00{member}.{y0}_2014_{timeframe}_abs.nc"                                                                # first for each variable load the data, for precipitation this consists of snow & rain from atmosphere, converted from [mm/day]                                pr_perturbation = xr.open_dataset(pr_perturbation_path).astype(np.float32)                                tas_perturbation = xr.open_dataset(tas_perturbation_path).astype(np.float32)                                                                            # repeat the data for precipitation and temperature                                pr_perturbation_timeseries = repeat_time_data(pr_perturbation, 'pr', date_range, time_id)/100 #convert from percentages                                tas_perturbation_timeseries = repeat_time_data(tas_perturbation, 'tas', date_range, time_id)                                                                ifile_baseline_pr=f"{ifolder_baseline_pr}/W5E5.PR.BASE.000.{y0}_2014_{timeframe}_abs.nc"                                ifile_baseline_tas=f"{ifolder_baseline_tas}/W5E5.TEMP.BASE.000.{y0}_2014_{timeframe}_abs.nc"                                # The baseline contains two seperate files for tas en pr and rename coordinates to match                                pr_baseline_timeseries_tot = xr.open_dataset(ifile_baseline_pr)                                tas_baseline_timeseries_avg = xr.open_dataset(ifile_baseline_tas)                                                                # print(pr_perturbation_timeseries)                                                         tas_perturbation_output = tas_baseline_timeseries_avg - tas_perturbation_timeseries                                pr_perturbation_output = pr_baseline_timeseries_tot + (pr_baseline_timeseries_tot * pr_perturbation_timeseries)                                                                        if model=="W5E5":                                                                tas_perturbation_output = tas_baseline_timeseries_avg[['lon','lat','time', 'tas']]                                 pr_perturbation_output = pr_baseline_timeseries_tot[['lon','lat','time', 'pr']]                                                                 if plot=='on':                                                vmin=0                                if timeframe=="monthly":                                    vmax=30                                if timeframe=="seasonal":                                    vmax=90                                if timeframe=="annual":                                    vmax=360                                zero_scaled = (abs(vmin)/(abs(vmin)+abs(vmax)))                                colors = [(0, 'xkcd:mocha'),(zero_scaled, 'xkcd:white'),(1, 'xkcd:aquamarine')]                                custom_cmap = LinearSegmentedColormap.from_list('custom_cmap', colors)                                 #                                                                     plt.figure()                                data = pr_baseline_timeseries_tot + (pr_baseline_timeseries_tot * pr_perturbation_timeseries)                                data = data.where((data.lon >= 60) & (data.lon <= 109) & (data.lat >= 22) & (data.lat <= 52), drop=True)                                data.pr.isel(time=1).plot(cmap=custom_cmap, vmin=vmin, vmax=vmax)                                plt.show()                                                        o_folder_pr = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/04. Perturbed Baseline/Precipitation/{timeframe}/{model}/{member}"                            o_folder_tas = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/04. Perturbed Baseline/Temperature/{timeframe}/{model}/{member}"                                        pr_data_out = f"{o_folder_pr}/REGRID.perturbed.baseline.{model}.PR.00{member}.{y0}_2014_{timeframe}.nc"                            tas_data_out = f"{o_folder_tas}/REGRID.perturbed.baseline.{model}.TEMP.00{member}.{y0}_2014_{timeframe}.nc"                                                        os.makedirs(o_folder_pr, exist_ok=True)                            os.makedirs(o_folder_tas, exist_ok=True)                                                            pr_perturbation_output.to_netcdf(pr_data_out, engine='h5netcdf')                            tas_perturbation_output.to_netcdf(tas_data_out, engine='h5netcdf')    