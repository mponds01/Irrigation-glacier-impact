""" This file processes W5E5 data to the required format to run in OGGM """ #%% Cell 0: Import required packagesimport pandas as pdimport xarray as xrimport numpy as npimport tarfileimport osimport xesmf as xeimport matplotlib.pyplot as plt#%% Cell 1: Open target formal file and input filesbase_path = "/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files"format_data_path = f"{base_path}/W5E5/format_datafile_histalp_merged_hef.nc"format_data = xr.open_dataset(format_data_path)climate_data_folder_path = f"{base_path}/W5E5/cluster.klima.uni-bremen.de" climate_data_file_path_pr=f"{climate_data_folder_path}/~oggm/climate/gswp3-w5e5/flattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019_flat_glaciers.nc"climate_data_file_path_tas=f"{climate_data_folder_path}/~oggm/climate/gswp3-w5e5/flattened/2023.2/monthly/gswp3-w5e5_obsclim_tas_global_monthly_1901_2019_flat_glaciers.nc"climate_data_pr = xr.open_dataset(climate_data_file_path_pr)climate_data_tas = xr.open_dataset(climate_data_file_path_tas)DEM_data_file_path = f"{base_path}/DEM/ETOPO2v2c_f4.nc" #source: https://gis.stackexchange.com/questions/366289/where-can-download-a-dem-for-whole-world-in-a-single-low-resolution-image#:~:text=ngdc.noaa.gov/mgg/global/relief/ETOPO2/ETOPO2v2%2D2006/ETOPO2v2c/%E2%80%A6DEM_data = xr.open_dataset(DEM_data_file_path)# Rename coordinates to ensure consistencyDEM_data = DEM_data.rename({'x': 'longitude', 'y': 'latitude'})def convert_longitudes(ds):    ds = ds.copy()    ds['longitude'] = ((ds['longitude'] + 180) % 360) - 180    ds = ds.sortby('longitude')    return ds# Apply conversion to climate data so the coordinates are in the same degreesclimate_data_pr = convert_longitudes(climate_data_pr)climate_data_tas = convert_longitudes(climate_data_tas)#%% Cell 1b: Convert climate data from points to a 2D griddef points_to_grid(ds, varname):    lon = ds['longitude']    lat = ds['latitude']        # Create the 2D grid    unique_lons = np.sort(np.unique(lon))    unique_lats = np.sort(np.unique(lat))        # Reindex the dataset to the 2D grid    reshaped = (ds[varname]                .set_index(points=['latitude', 'longitude'])                .unstack('points')                .reindex(latitude=unique_lats, longitude=unique_lons))        return reshaped# Convert climate data to 2D gridclimate_data_pr_grid = points_to_grid(climate_data_pr, 'pr')climate_data_tas_grid = points_to_grid(climate_data_tas, 'tas')# Create Dataset from DataArrayclimate_data_pr_grid = climate_data_pr_grid.to_dataset(name='pr')climate_data_tas_grid = climate_data_tas_grid.to_dataset(name='tas')#%% Cell 2: Regrid the data# Select the region of interest for regridding# region = {#     'min_lon': 88,#     'max_lon': 97,#     'min_lat': 28,#     'max_lat': 37}# ds_in_grid = DEM_data.sel(longitude=slice(region['min_lon'], region['max_lon']), latitude=slice(region['min_lat'], region['max_lat']))# ds_out_grid = climate_data_pr_grid.sel(longitude=slice(region['min_lon'], region['max_lon']), latitude=slice(region['min_lat'], region['max_lat']))#if not slicing to a smaller partds_in_grid = DEM_datads_out_grid = climate_data_pr_grid# Define the target grid using climate data gridds_out_grid_format = xr.Dataset({    'latitude': ds_out_grid.latitude,    'longitude': ds_out_grid.longitude })# Create the regridder# print(ds_in.data_vars)regridder = xe.Regridder(ds_in_grid, ds_out_grid_format, 'bilinear', periodic=True, extrap_method='nearest_s2d')# # Reformat the input and output shape bcs else a error will result from conversion: https://github.com/pangeo-data/xESMF/issues/315regridder.shape_in = tuple(map(int, regridder.shape_in))regridder.shape_out = tuple(map(int, regridder.shape_out))# Perform the regriddingregridded_data={}for (v,var) in enumerate(ds_in_grid.data_vars):    regridded_data[var] = regridder(ds_in_grid[var])# Create the regridded datasetregridded_ds = xr.Dataset(regridded_data)regridded_ds = regridded_ds.where(~np.isnan(ds_out_grid.isel(time=0).pr.values))#%% Cell 3: Save the regridded data - IF ERROR: delete the previously created filefolder_out="/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/DEM/01. Regridded"   #create a new directory if it doesnt exist yetos.makedirs(folder_out, exist_ok=True)data_out=f"{folder_out}/REGRID.MASKED.ETOPO2v2c_f4.nc" print("saving file to:", data_out)regridded_ds.to_netcdf(data_out)#%% Cell 3: Plot the regridded data# climate_data_pr_slice = climate_data_pr_grid.sel(longitude=slice(region['min_lon'], region['max_lon']), latitude=slice(region['min_lat'], region['max_lat']))# climate_data_tas_slice = climate_data_tas_grid.sel(longitude=slice(region['min_lon'], region['max_lon']), latitude=slice(region['min_lat'], region['max_lat']))climate_data_pr_slice=climate_data_pr_gridclimate_data_tas_slice=climate_data_tas_gridregridded_ds_path = data_outclimate_data_z_slice = xr.open_dataset(regridded_ds_path)# Now merge the datasets based on latitude and longitudemerged_data = xr.merge([climate_data_pr_slice, climate_data_tas_slice, climate_data_z_slice])merged_data = merged_data.rename({'longitude': 'lon',                                   'latitude': 'lat',                                  'z': 'hgt',                                  'pr': 'prcp',                                  'tas': 'temp'})# Transpose to reorder dimensionsmerged_data_transposed = merged_data.transpose('time', 'lat', 'lon')# Reorder the variables in the Datasetmerged_data_output = merged_data_transposed[['hgt', 'prcp', 'temp']]# Save the merged datafolder_out="/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/W5E%/01. Regridded"   merged_data_out = f"{folder_out}/W5E5_MERGED_MASKED_DATA.nc"print("saving merged file to:", merged_data_out)merged_data_output.to_netcdf(merged_data_out)#%% Cell 4: Investigate the merged datads = xr.open_dataset(merged_data_out)fig, axs = plt.subplots(1,3, figsize=(12,4), sharey=True)ds.hgt.plot(ax=axs[0], cmap='viridis')axs[0].set_title('HGT Variable')ds.temp.isel(time=0).plot(ax=axs[1], cmap='Reds')axs[1].set_title('Temperature Variable')ds.prcp.isel(time=0).plot(ax=axs[2], cmap='Blues')axs[2].set_title('Precipitation Variable')# Adjust layoutplt.tight_layout()plt.show()