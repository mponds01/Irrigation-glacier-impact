""" This file processes W5E5 data to the required format to run in OGGM """ #%% Cell 0: Import required packagesimport pandas as pdimport xarray as xrimport numpy as npimport tarfileimport osimport xesmf as xeimport matplotlib.pyplot as plt#%% Define function to normalize latitudesdef reverse_latitudes(ds):    latitudes = ds.lat.values    if latitudes[0] > latitudes[-1]:  # Latitudes are in descending order        ds = ds.reindex(lat=ds.lat[::-1])  # Reverse the latitude coordinates and data    return ds#%% Cell 1: Open target formal file and input filesbase_path = "/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files"format_data_path = f"{base_path}/01. Climate data/W5E5/format_datafile_histalp_merged_hef.nc"format_data = xr.open_dataset(format_data_path)climate_data_folder_path = f"{base_path}/01. Climate data/W5E5/cluster.klima.uni-bremen.de" climate_data_file_path_pr=f"{climate_data_folder_path}/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc"climate_data_file_path_tas=f"{climate_data_folder_path}/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_tas_global_monthly_1901_2019.nc"climate_data_pr = xr.open_dataset(climate_data_file_path_pr)climate_data_tas = xr.open_dataset(climate_data_file_path_tas)climate_data_pr = reverse_latitudes(climate_data_pr)climate_data_tas = reverse_latitudes(climate_data_tas)DEM_data_file_path = f"{base_path}/02. DEM/ETOPO2v2c_f4.nc" #source: https://gis.stackexchange.com/questions/366289/where-can-download-a-dem-for-whole-world-in-a-single-low-resolution-image#:~:text=ngdc.noaa.gov/mgg/global/relief/ETOPO2/ETOPO2v2%2D2006/ETOPO2v2c/%E2%80%A6DEM_data = xr.open_dataset(DEM_data_file_path)# Rename coordinates to ensure consistencyDEM_data = DEM_data.rename({'x': 'lon', 'y': 'lat'})# DEM_data=normalize_latitudes(DEM_data)#%% Cell 2: Regrid the DEM data (all climate data has already been regridded before in the creation of climate data files)"""Please note operation takes ~10mins for global datasets"""# Select the region of interest for regridding# region = {#     'min_lon': 88,#     'max_lon': 97,#     'min_lat': 28,#     'max_lat': 37}# ds_in_grid = DEM_data.sel(lon=slice(region['min_lon'], region['max_lon']), lat=slice(region['min_lat'], region['max_lat']))# ds_out_grid = climate_data_pr.sel(lon=slice(region['min_lon'], region['max_lon']), lat=slice(region['min_lat'], region['max_lat']))#if not slicing to a smaller partds_in_grid = DEM_datads_out_grid = climate_data_pr# Define the target grid using climate data gridds_out_grid_format = xr.Dataset({    'lat': ds_out_grid.lat,    'lon': ds_out_grid.lon })# Create the regridder# print(ds_in.data_vars)regridder = xe.Regridder(ds_in_grid, ds_out_grid_format, 'bilinear', extrap_method='nearest_s2d')# # # Reformat the input and output shape bcs else a error will result from conversion: https://github.com/pangeo-data/xESMF/issues/315regridder.shape_in = tuple(map(int, regridder.shape_in))regridder.shape_out = tuple(map(int, regridder.shape_out))# Perform the regriddingregridded_data={}for (v,var) in enumerate(ds_in_grid.data_vars):    regridded_data[var] = regridder(ds_in_grid[var])# Create the regridded datasetregridded_ds = xr.Dataset(regridded_data)regridded_ds = regridded_ds.where(~np.isnan(ds_out_grid.isel(time=0).pr.values))#%% Cell 3: Save the regridded data - IF ERROR: delete the previously created filedem_output_path=f"{base_path}/02. DEM/01. Regridded"dem_file_out=f"{dem_output_path}/REGRID.ETOPO2v2c_f4.global.nc"#create a new directory if it doesnt exist yetos.makedirs(dem_output_path, exist_ok=True)regridded_ds.to_netcdf(dem_file_out)#%% Cell 3: Create function for creating new climate data filesdef create_oggm_climate_input(dem_file, model, member, timeframe):        #load the data files for all climate models, including W5E5    climate_data_folder_path = "/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/04. Perturbed Baseline/"    climate_data_file_path_pr=f"{climate_data_folder_path}/Precipitation/{timeframe}/{model}/{member}/REGRID.perturbed.baseline.{model}.PR.00{member}.1985_2014_{timeframe}.nc"    climate_data_file_path_tas=f"{climate_data_folder_path}/Temperature/{timeframe}/{model}/{member}/REGRID.perturbed.baseline.{model}.TEMP.00{member}.1985_2014_{timeframe}.nc"                                                                                                  climate_data_z = dem_file.rename({'z': 'hgt'})    climate_data_pr = xr.open_dataset(climate_data_file_path_pr, engine='h5netcdf').rename({'pr': 'prcp'})    climate_data_tas = xr.open_dataset(climate_data_file_path_tas, engine='h5netcdf').rename({'tas': 'temp'})        # Convert temperature from Kelvin to degrees Celsius    climate_data_tas['temp'] = climate_data_tas['temp'] - 273.15        #reverse the latitudes to ascending order    climate_data_pr = reverse_latitudes(climate_data_pr)    climate_data_tas = reverse_latitudes(climate_data_tas)        # Now merge the datasets based on latitude and longitude    merged_data = xr.merge([climate_data_pr, climate_data_tas, climate_data_z])    merged_data = merged_data        # #Alternative to try    merged_data = merged_data[["lon", "lat", "time", "prcp", "temp", "hgt"]]        merged_data.prcp.attrs['units'] = "mm"    merged_data.temp.attrs['units'] = "degc"    merged_data.hgt.attrs['units'] = "m"        # standard_name attribute    merged_data.prcp.attrs['standard_name'] = "precipitation"    merged_data.temp.attrs['standard_name'] = "temperature"    # Save the merged data      o_folder_clim = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/05. OGGM Climate input files/{timeframe}/{model}/{member}"    merged_data_out = f"{o_folder_clim}/{model}.00{member}.1985_2014.{timeframe}.perturbed.climate.input.degC.nc"    os.makedirs(o_folder_clim, exist_ok=True)        merged_data.to_netcdf(merged_data_out)#, engine='h5netcdf')    print(merged_data.dims)    # print("saving merged file to:", merged_data_out)      return#%% Cell 4: Run climate functiondem_output_path=f"{base_path}/02. DEM/01. Regridded"dem_file_out=f"{dem_output_path}/REGRID.ETOPO2v2c_f4.global.nc"dem_file=xr.open_dataset(dem_file_out)#,engine='h5netcdf')members = [1, 3, 4, 6,1]for (m, model) in enumerate(["IPSL-CM6", "E3SM", "CESM2", "CNRM", "W5E5"]):    for member in range(members[m]):        for timeframe in ["annual", "seasonal", "monthly"]:            for mode in ['DIF']: # alternatively also for std, not of interest at the moment                print(model, member, timeframe)                create_oggm_climate_input(dem_file, model, member, timeframe)#%% Cell 4: Investigate the merged data - plot with 3 panels for Hgt, temperature and prcpo_folder_clim = f"/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/05. OGGM Climate input files/{timeframe}/{model}/{member}"merged_data_out = f"{o_folder_clim}/{model}.00{member}.1985_2014.{timeframe}.perturbed.climate.input.nc"ds = xr.open_dataset(merged_data_out)fig, axs = plt.subplots(1,3, figsize=(12,4), sharey=True)ds.hgt.plot(ax=axs[0], cmap='viridis')axs[0].set_title('HGT Variable')ds.temp.isel(time=0).plot(ax=axs[1], cmap='Reds')axs[1].set_title('Temperature Variable')ds.prcp.isel(time=0).plot(ax=axs[2], cmap='Blues')axs[2].set_title('Precipitation Variable')# Adjust layoutplt.tight_layout()plt.show()