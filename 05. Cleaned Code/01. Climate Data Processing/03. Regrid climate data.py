"""Created on Mon Apr 22 14:14:34 2024@author: magaliponds""""""This script regrids the perturbations to W5E5 resoltuion to allow overlay:    1. Function to regrid the climate data for historic pertrubations    2. Function to regrid the climate data for counterfactual pertrubations    3. Function to regrid the climate data for future pertrubations    4. Loop through the regridding functions for all model member combinations in IRRMIP (past, counterfactual, future)NOTE: Scipt preferrably run in xemsf environment"""#%% Cell 0: Load packagesimport geopandas as gpdimport matplotlib.pyplot as pltimport matplotlib.cm as cmimport xarray as xrimport osimport seaborn as snsimport salemfrom matplotlib.ticker import FuncFormatterfrom shapely.geometry import Pointimport pandas as pdimport numpy as npfrom matplotlib import animationimport cartopy.crs as ccrsimport cartopy.feature as cfeaturefrom IPython.display import HTML, displayfrom matplotlib.colors import ListedColormapfrom matplotlib.colors import LinearSegmentedColormapfrom cartopy.mpl.gridliner import LONGITUDE_FORMATTER, LATITUDE_FORMATTERimport globimport xesmf as xe# %% Cell 1: (Default) regrid climate data  from raw input data, using  bilinear and nearest neighbour (perturbations only for now)def regrid_climate_data(plotvar, model, member, var, timeframe, mode, diftype, y0, ye):    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """    # Part 0: Provide regridding parameter    if var == "Precipitation":        var_suffix = "PR"        var_idx = "pr"    else:        var_suffix = "TEMP"        var_idx = "tas"    mode_suff = 'total'  # other option is std, but we're not interested in that for now    # Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid = xr.open_dataset(w5e5_path)    # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values,  # 'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values  # 'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })    # Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}"    if plotvar == "DIF":        # ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        # ifile_diff = f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    ds_in = xr.open_dataset(ifile_diff, engine="netcdf4")  # open the dataset    # find out what the variables are in each dataset    # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear',                             periodic=True, extrap_method='nearest_s2d')    # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))    # Perform the regridding    regridded_data = {}    regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)    "Regridded attributes:"    if var == "Precipitation":        regridded_ds.pr.attrs.update(ds_in.pr.attrs)    else:        regridded_ds.tas.attrs.update(ds_in.tas.attrs)    # print(regridded_ds.data_vars)    # Save the regridded data    base_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"    # create a new directory if it doesnt exist yet    if plotvar == "DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        # data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        # data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    # print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return# %% Cell 2: Counterfactual regriddingdef regrid_climate_data_counterfactual(plotvar, model, member, var, timeframe, mode, diftype):    y0 = 1985    ye = 2014    y0_cf = 1901    ye_cf = 1930    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """    # Part 0: Provide regridding parameter    if var == "Precipitation":        var_suffix = "PR"        var_idx = "pr"    else:        var_suffix = "TEMP"        var_idx = "tas"    mode_suff = 'total'  # other option is std, but we're not interested in that for now    # Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid = xr.open_dataset(w5e5_path)    # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values,  # 'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values  # 'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })    # Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}"    if plotvar == "DIF":        # ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    else:        # ifile_diff = f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    ds_in = xr.open_dataset(ifile_diff)  # open the dataset    # find out what the variables are in each dataset    # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear',                             periodic=True, extrap_method='nearest_s2d')    # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))    # Perform the regridding    regridded_data = {}    regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)    "Regridded attributes:"    if var == "Precipitation":        regridded_ds.pr.attrs.update(ds_in.pr.attrs)    else:        regridded_ds.tas.attrs.update(ds_in.tas.attrs)    # print(regridded_ds.data_vars)    # Save the regridded data    base_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}"    diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}"    # create a new directory if it doesnt exist yet    if plotvar == "DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        # data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0_cf}_{y0}_{timeframe}_{diftype}_counterfactual.nc"        # data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    # print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return# %% Cell 3: Future regriddingdef regrid_climate_data_future(plotvar, model, member, var, timeframe, mode, diftype, y0, ye, scenario):    """input variables:         plotvar = type of variable to regrid, either difference (DIF) or original input datasets (IRR or NOI) - currently only defined for DIF        model = climate model,        member = associated model member, '0" is average of all members        var = either temperature of precipitation (includes prcp from snowfall)        timeframe = either annual, seasonal or monthly        mode = difference or standard deviation (std never used)        dif = difference type: absolute or relative (default: rel for prcp and abs for temperature)        """    # Part 0: Provide regridding parameter    if var == "Precipitation":        var_suffix = "PR"        var_idx = "pr"    else:        var_suffix = "TEMP"        var_idx = "tas"    mode_suff = 'total'  # other option is std, but we're not interested in that for now    # Part 1a: Open the target grid: climate dataset- W5E5    w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/03. Data/01. Input files/01. Climate data/W5E5/cluster.klima.uni-bremen.de/~oggm/climate/gswp3-w5e5/unflattened/2023.2/monthly/gswp3-w5e5_obsclim_pr_global_monthly_1901_2019.nc'    grid = xr.open_dataset(w5e5_path, engine="netcdf4")    # Define the target grid    ds_out = xr.Dataset({        'lat': grid.lat.values,  # 'lat': (['lat'], np.arange(-90, 90.1, 1.0)),        'lon': grid.lon.values  # 'lon': (['lon'], np.arange(0, 360.1, 1.0)),    })    # Part 1b: Load the input data (derived in function process_P_T_perturbations)    base_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}/SSP{scenario}"    diff_folder_in = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/02. Perturbations/{var}/{timeframe}/{model}/{member}/SSP{scenario}"    if plotvar == "DIF":        # ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.SSP{scenario}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        # ifile_diff = f"{base_folder_in}/{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        ifile_diff = f"{diff_folder_in}/{model}.{var_suffix}.SSP{scenario}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    ds_in = xr.open_dataset(ifile_diff, engine="netcdf4")  # open the dataset    # find out what the variables are in each dataset    # Create the regridder    regridder = xe.Regridder(ds_in, ds_out, 'bilinear',                             periodic=True, extrap_method='nearest_s2d')    # Reformat the input and output shape bcs else a error will result from conversion    # https://github.com/pangeo-data/xESMF/issues/315    regridder.shape_in = tuple(map(int, regridder.shape_in))    regridder.shape_out = tuple(map(int, regridder.shape_out))    # Perform the regridding    regridded_data = {}    regridded_data[var_idx] = regridder(ds_in[var_idx])    regridded_ds = xr.Dataset(regridded_data)    "Regridded attributes:"    if var == "Precipitation":        regridded_ds.pr.attrs.update(ds_in.pr.attrs)    else:        regridded_ds.tas.attrs.update(ds_in.tas.attrs)    # print(regridded_ds.data_vars)    # Save the regridded data    base_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/01. Processed input data/{var}/{timeframe}/{model}/{member}/SSP{scenario}"    diff_folder_out = f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/03. Data/03. Output files/01. Climate data/03. Regridded Perturbations/{var}/{timeframe}/{model}/{member}/SSP{scenario}"    # create a new directory if it doesnt exist yet    if plotvar == "DIF":        # os.makedirs(f"o_folder_base/{scale}/{timeframe}/{var}/", exist_ok=True)        os.makedirs(f"{diff_folder_out}/", exist_ok=True)        # data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        data_out = f"{diff_folder_out}/REGRID.{model}.{var_suffix}.SSP{scenario}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    else:        os.makedirs(f"{base_folder_out}/", exist_ok=True)        data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.SSP{scenario}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"        # data_out = f"{base_folder_out}/REGRID.{model}.{var_suffix}.{plotvar}.00{member}.{y0}_{ye}_{timeframe}_{diftype}.nc"    # print("saving file to:", data_out)    regridded_ds.to_netcdf(data_out)    return# %% Cell 4: Run through regridder for all climate datamembers = [4]  # 1, 3, 4, 6,3]# "IPSL-CM6", "E3SM", "CESM2", "CNRM", "NorESM"]):for (m, model) in enumerate(["CESM2"]):    for member in range(members[m]):        if member != 0:            # alternatively also for IRR, NOI, not of interest at the moment            for plotvar in ["DIF"]:                # "Precipitation", "Temperature"]:  # , "Precipitation"]:                for var in ["Precipitation"]:  # "Precipitation"]:                    for timeframe in ["annual", "seasonal", "monthly"]:                        # alternatively also for std, not of interest at the moment                        for mode in ['dif']:                            if plotvar == "DIF" and var == "Precipitation" and mode == 'dif':                                diftypes = ['abs', 'rel']                            else:                                diftypes = ['abs']                            for dif in diftypes:                                print(plotvar, model, member, var, dif)                                # if model=="NorESM":                                # regrid_climate_data(                                # plotvar, model, member, var, timeframe, mode, dif, 1985, 2014)                                # regrid_climate_data(                                # plotvar, model, member, var, timeframe, mode, dif, 1901, 1930)                                # regrid_climate_data_counterfactual(                                # plotvar, model, member, var, timeframe, mode, dif)                                for scenario in ["126", "370"]:                                    regrid_climate_data_future(                                        plotvar, model, member, var, timeframe, mode, dif, 2015, 2074, scenario)