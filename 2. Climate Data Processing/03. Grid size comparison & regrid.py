import geopandas as gpdimport matplotlib.pyplot as pltimport matplotlib.cm as cmimport xarray as xrimport osimport seaborn as snsimport salemfrom matplotlib.ticker import FuncFormatterfrom shapely.geometry import Point import pandas as pdimport numpy as npfrom matplotlib import animationimport cartopy.crs as ccrsimport cartopy.feature as cfeaturefrom IPython.display import HTML, displayfrom matplotlib.colors import ListedColormapfrom matplotlib.colors import LinearSegmentedColormapimport xesmf as xe#%% Cell 1: Download & plot climate data# cmap=cm.get_cmap('bone')# colors=[cmap(i / 5) for i in range(6)]fig, ax = plt.subplots(figsize=(20, 10), subplot_kw={'projection': ccrs.PlateCarree()})colors=['red', 'cyan', 'blue', 'purple', 'black']models=["W5E5", "IPSL-CM6","E3SM","CESM2", "CNRM"] mode_suff='total'#%% for (i,model) in enumerate(models):     color_code=colors[i]        """ Load the data """    if model=="W5E5":        w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'        # print(w5e5_path)        grid=xr.open_dataset(w5e5_path)        linestyle="dashed"    else:        folder=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/"           ifile_IRR=f"{model}.IRR.000.1985_2014_selparam_monthly_{mode_suff}.nc"        linestyle="dashed"            #first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]        grid =xr.open_dataset(folder+ifile_IRR)            #cut out the  relevants seciton to later plot on the grid    grid = grid.where((grid.lon >= 88) & (grid.lon <= 97) & (grid.lat >= 28) & (grid.lat <= 37), drop=True)    #define the lon and latitude poitns in the dataset    lon = grid.lon    lat = grid.lat        print(model, lon[1:5].values, lat[1:5].values)    #create a meshgrid out of the lon and latitude points    lon_grid, lat_grid = np.meshgrid(lon, lat)    # print(lon_grid, lat_grid)        # Plot the grid lines, using a scatter graph for the corners and connect htem in a loop    for j in range(len(lon)):        for k in range(len(lat)):            if j < len(lon) - 1 and k < len(lat) - 1:                ax.plot([lon[j], lon[j+1]], [lat[k], lat[k]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                ax.plot([lon[j], lon[j]], [lat[k], lat[k+1]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                # ax.fill_between([lon[j], lon[j+1]], lat[k], lat[k+1], color=color_code, alpha=0.3)  # Fill squares    ax.scatter(lon_grid, lat_grid, color=color_code, marker='s', label=model, s=50)#modify the figureax.set_xlim((90,95))  # Adjust as neededax.set_ylim((30,35))  # Adjust as neededax.set_xticks(np.arange(90, 96, 1))  # Adjust as neededax.set_yticks(np.arange(30, 36, 1))  # Adjust as neededax.set_ylabel('Latitude 째')ax.set_xlabel('Longitude 째')ax.legend()ax.set_title('Data Product Grid by Climate model')plt.tight_layout()# plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9)plt.show()        # Add geographic features    # ax.add_feature(cfeature.COASTLINE)    # ax.add_feature(cfeature.BORDERS)    # ax.add_feature(cfeature.LAND, edgecolor='black')    #%% Cell 2: regrid climate data using bilinear and nearest neighbour#open w5e5 dataset as this is the target gridw5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'grid=xr.open_dataset(w5e5_path)# Define the target gridds_out = xr.Dataset({    'lat': grid.lat.values, #'lat': (['lat'], np.arange(-90, 90.1, 1.0)),    'lon': grid.lon.values #'lon': (['lon'], np.arange(0, 360.1, 1.0)),})mode_suff='total'types=['IRR', 'NOI']for (i,model) in enumerate(models):     if model=="E3SM" or model=="CESM2":        if model =="E3SM":            members=3 #2 members 1 average        else:            members=4        variables=['pr', 'tas', 'sn'] #snow data only available for IPSL-CM6 and E3SM    else:        if model=="IPSL-CM6":            members=1 #1 members = average        else:            members=6 #5 members, 1 average        variables=['pr', 'tas'] #snow data only available for IPSL-CM6 and E3SM        if model != "W5E5":         for typ in types:            for m in np.arange(0,members,1):                folder_in=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}"                   data_in=f"{folder_in}/{model}.{typ}.00{m}.1985_2014_selparam_monthly_{mode_suff}.nc"                ds_in = xr.open_dataset(data_in)                # print(ds_in.data_vars)                # ds_in['mask'] = xr.where(np.isfinite(var), 1, 0)                        # Create the regridder                regridder = xe.Regridder(ds_in, ds_out, 'bilinear', periodic=True, extrap_method='nearest_s2d')                                # Reformat the input and output shape bcs else a error will result from conversion                # https://github.com/pangeo-data/xESMF/issues/315                regridder.shape_in = tuple(map(int, regridder.shape_in))                regridder.shape_out = tuple(map(int, regridder.shape_out))                        # Perform the regridding                regridded_data={}                for (v,var) in enumerate(variables):                    print(model, var)                    regridded_data[var] = regridder(ds_in[var])                regridded_ds = xr.Dataset(regridded_data)                        print(regridded_ds.data_vars)                        # Save the regridded data                folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/01. Regridded data"                   #create a new directory if it doesnt exist yet                os.makedirs(folder_out, exist_ok=True)                data_out=f"{folder_out}/REGRID.{model}.{typ}.00{m}.1985_2014_selparam_monthly_{mode_suff}.nc"                print("saving file to:", data_out)                regridded_ds.to_netcdf(data_out)#%% Cell 3: check regridded climate datafig, ax = plt.subplots(figsize=(20, 10), subplot_kw={'projection': ccrs.PlateCarree()})for (i,model) in enumerate(models):     color_code=colors[i]        """ Load the data """    if model=="W5E5":        w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'        # print(w5e5_path)        grid=xr.open_dataset(w5e5_path)        linestyle="dashed"    else:        folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/01. Regridded data"           data_out=f"{folder_out}/REGRID.{model}.IRR.000.1985_2014_selparam_monthly_{mode_suff}.nc"        linestyle="dashed"            #first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]        grid =xr.open_dataset(data_out)            #cut out the  relevants seciton to later plot on the grid    grid = grid.where((grid.lon >= 88) & (grid.lon <= 97) & (grid.lat >= 28) & (grid.lat <= 37), drop=True)    #define the lon and latitude poitns in the dataset    lon = grid.lon    lat = grid.lat        print(model, lon[1:5].values, lat[1:5].values)    #create a meshgrid out of the lon and latitude points    lon_grid, lat_grid = np.meshgrid(lon, lat)    # print(lon_grid, lat_grid)        # Plot the grid lines, using a scatter graph for the corners and connect htem in a loop    for j in range(len(lon)):        for k in range(len(lat)):            if j < len(lon) - 1 and k < len(lat) - 1:                ax.plot([lon[j], lon[j+1]], [lat[k], lat[k]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                ax.plot([lon[j], lon[j]], [lat[k], lat[k+1]], linestyle=linestyle, color=color_code, alpha=0.6, dashes=[5,5])                # ax.fill_between([lon[j], lon[j+1]], lat[k], lat[k+1], color=color_code, alpha=0.3)  # Fill squares    ax.scatter(lon_grid, lat_grid, color=color_code, marker='s', label=model, s=50)#modify the figureax.set_xlim((90,95))  # Adjust as neededax.set_ylim((30,35))  # Adjust as neededax.set_xticks(np.arange(90, 96, 1))  # Adjust as neededax.set_yticks(np.arange(30, 36, 1))  # Adjust as neededax.set_ylabel('Latitude 째')ax.set_xlabel('Longitude 째')ax.legend()ax.set_title('REGRIDDED - Data Product Grid by Climate model')plt.tight_layout()# plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9)plt.show()            # Add geographic features    # ax.add_feature(cfeature.COASTLINE)    # ax.add_feature(cfeature.BORDERS)    # ax.add_feature(cfeature.LAND, edgecolor='black')#%% Cell 4: Show dataset before and after regriddingfor (i,model) in enumerate(models):     color_code=colors[i]        """ Load the data """    if model=="W5E5":        w5e5_path = '/Users/magaliponds/Library/CloudStorage/OneDrive-VrijeUniversiteitBrussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/W5E5/huss_W5E5v2.0_20110101-20191231.nc'        # print(w5e5_path)        grid=xr.open_dataset(w5e5_path)        linestyle="dashed"    else:        folder_out=f"/Users/magaliponds/OneDrive - Vrije Universiteit Brussel/1. VUB/02. Coding/01. IRRMIP/02. Data/01. Input files/{model}/01. Regridded data"           data_out=f"{folder_out}/REGRID.{model}.IRR.000.1985_2014_selparam_monthly_{mode_suff}.nc"        linestyle="dashed"            #first for each variable load the data, for precipitation this consists of Snow & Rain from atmosphere, converted from [mm/day]        grid =xr.open_dataset(data_out)    